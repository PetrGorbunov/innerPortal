<apex:page controller="ResourcesAndAvailabilityController"
    showHeader="true"
    sidebar="false"
    title="Resources&Availability"
    standardStylesheets="false">

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.1/angular.min.js"></script>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css"/>

    <head>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    </head>

    <style type="text/css">

        .same-row {
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            flex-wrap: wrap;
        }
        .same-row > [class*='col-'] {
            display: flex;
            flex-direction: column;
        }

        .addInfoBody {
            border: 1px solid lightgrey;
        }

        .form-control {
            width:auto;
            display:inline-block;
        }
        .form-group {
            margin: 0px;
        }
        .container {
            width: auto;
            height: 100%;
            margin: 5px 5px 0px 5px;
            padding: 5px;
            border: 1px solid black;
            border-radius: 5px;
        }

        .left-column .container {
            margin-right: 0px;
        }

        .paddingBottom {
            padding-bottom: 20px;
        }
        .left-column {
            padding-right: 0px;
        }
        .right-column {
            padding-left: 0px;
        }

        .hotpink {
            background-color: #F69393;
        }

        .hotpink:hover {
            background-color: hotpink;
        }
        .yellow {
            background-color: #EFDC5D;
        }

        .yellow:hover {
            background-color: #E4C707;
        }

        .lightblue {
            background-color: lightblue;
        }
        .lightgreen {
            background-color: #8FF78D;
        }


        .lightgreen:hover {
            background-color: #4AFA47;
        }
        .blue {
            background: #8D9BF7;
            color: white;
        }

        .weight {
            font-weight: bold;
        }

        .AddInfoTable {
            border-top: 0px solid;
            width: 100%;
        }

        .AddInfoTable td {
            vertical-align: top;
        }

        .AddInfoTitle {
            font-weight: bold;
            text-decoration: underline;
        }

        .titleFilter {
            border-bottom: 1px solid black;
            margin-bottom: 20px;
        }

        .withoutMarge {
            margin: 0px;
        }

        .borderBottom {
            border-bottom: 1px dotted black;
            margin: 10px;
            padding-bottom: 10px;
        }

        .scroll {
            overflow-y: scroll;
            overflow-x: hidden;
        }

    </style>

    <div ng-app="ResAndAvail" ng-controller="ResAndAvailCtrl">
        <div ng-show="getDataStatus != 'Finished'">
            Loading data... Please wait...
        </div>

        <div ng-show="getDataStatus == 'Finished'" class="ng-hide">

            <!-- Header's panels -->
            <div class="row">
                <!-- Header with logo -->
                <div id="divHeader" class="col-md-12">
                    <div class="container lightblue">
                        <apex:image id="VRPLogo" url="{!URLFOR($Resource.vrprce__Logos, '/VRP.png')}" height="10%" width="10%" />
                        VRP Thinking globally, delivering locally
                    </div>
                </div>

                <!-- Bookmarks panel -->
                <div id="bookmakerViewer" class="col-md-12">
                    <div class="container blue">
                        Bookmarked:
                        <span ng-show="bookmarkedPeople.length == 0">
                            None
                        </span>
                        <button id="btnReserve" class="btn btn-default" ng-show="bookmarkedPeople.length > 0">
                            Reserve / Allocate Selected
                        </button>
                    </div>
                </div>

                <!-- Searching panel -->
                <div class="col-md-12">
                    <div class="container blue">
                        <div id="divSearching" class="form-group row">
                            <div class="col-md-5 text-center">
                                <label for="slcProjects">Projects</label>
                                <select id="slcProjects" class="form-control" ng-options="project.Name for project in allDataFromServer.Projects" ng-model="filters.selectedProject">
                                </select>

                                <label class="checkbox-inline" >
                                    <input type="checkbox" id="chbProjectHistory" ng-model="filters.projectHistory"/>
                                    Include historical data
                                </label>
                            </div>

                            <div class="col-md-5 text-center">
                                <label for="slcClients">Client</label>
                                <select id="slcClients" class="form-control" ng-options="client.Account__r.Name for client in allDataFromServer.Clients" ng-model="filters.selectedClient">
                                </select>

                                <label class="checkbox-inline" >
                                    <input type="checkbox" id="chbClientHistory" ng-model="filters.clientHistory"/>
                                    Include historical data
                                </label>

                                <button id="btnSearch" class="btn btn-default ">
                                    Search
                                </button>
                            </div>

                            <div class="col-md-2 text-center">
                                <button id="btnMapView" class="btn btn-default ">
                                    Map View
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main table block -->
            <div class="row same-row">
                <div   class="col-md-10 left-column ">
                    <div class="container">

                        <div id="divMainTable">
                            <table class="table">
                                <thead>
                                    <th>Full Name</th>
                                    <th>Department</th>
                                    <th>Experience Level</th>
                                    <th>English Level</th>
                                    <th>US Visa</th>
                                    <th>Immediate Availability (h)</th>
                                    <th>Project Allocation</th>
                                    <th>From</th>
                                    <th>To</th>
                                    <th>Team Lead</th>
                                    <th>Account</th>
                                </thead>
                                <tbody>
                                    <tr ng-repeat-start="developer in tableData | projects:filters.selectedProject:filters.projectHistory | clients:filters.selectedClient:filters.clientHistory | accounts:filters.accounts | departments:filters.departments | available:filters.immediateAvailable | orderBy:sort.columns:false | paginator:paginator" ng-class="developer.availabilityHours == 0 ? 'hotpink' : (developer.Immediate <= 4 ? 'yellow' : 'lightgreen')" ng-click="isAddInfoVisible = !isAddInfoVisible">
                                        <td>{{developer.contact.Name}}</td>
                                        <td>{{developer.contact.Job_Title__c}}</td>
                                        <td>{{developer.contact.Experience_Level__c}}</td>
                                        <td>{{developer.contact.English_Level__c}}</td>
                                        <td>
                                            <p ng-show="developer.contact.Employee_Private_Documents__r">true</p>
                                        </td>
                                        <td>{{developer.availabilityHours}} {{developer.availabilityAddInfo}}</td>
                                        <td>{{developer.currentProject.Project__r.Name}}</td>
                                        <td>{{developer.currentProject.Start_Date__c | date:"mm/dd/yyyy"}}</td>
                                        <td>{{developer.currentProject.End_Date__c | date:"mm/dd/yyyy"}}</td>
                                        <td>{{developer.contact.Employee_User__r.Manager.Name}}</td>
                                        <td>{{developer.contact.Account.Name}}</td>
                                    </tr>
                                    <tr ng-show="isAddInfoVisible" ng-repeat-end="ng-repeat-end">
                                       <td colspan="11">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <p class="AddInfoTitle">Contact Infornation</p>
                                                    <div class="addInfoBody">
                                                        <div class="withoutMarge row">
                                                            <div class="key col-md-4">Email</div>
                                                            <div class="value col-md-8">{{developer.contact.Email}}</div>
                                                        </div>
                                                        <div class="withoutMarge row">
                                                            <div class="key col-md-4">Phone</div>
                                                            <div class="value col-md-8">{{developer.contact.Phone}}</div>
                                                        </div>
                                                        <div class="withoutMarge row">
                                                            <div class="key col-md-4">Skype</div>
                                                            <div class="value col-md-8">{{developer.contact.Skype__c}}</div>
                                                        </div>
                                                        <div class="withoutMarge row">
                                                            <div class="key col-md-4">Google Talk</div>
                                                            <div class="value col-md-8">{{developer.contact.Google_Talk__c}}</div>
                                                        </div>

                                                        <div class="withoutMarge row">
                                                            <div class="key col-md-4">Hired Date</div>
                                                            <div class="value col-md-8">{{developer.contact.Hired_Date__c | date:"MM/dd/yyyy"}}</div>
                                                        </div>
                                                        <div class="withoutMarge row">
                                                            <div class="key col-md-4">Emergensy phone</div>
                                                            <div class="value col-md-8">{{developer.contact.Emergency_Phone__c}}</div>
                                                        </div>
                                                        <div class="withoutMarge row">
                                                            <div class="key col-md-4">Vacation Last</div>
                                                            <div class="value col-md-8">{{developer.lastVacation}}</div>
                                                        </div>
                                                        <div class="withoutMarge row">
                                                            <div class="key col-md-4">Vacation Next</div>
                                                            <div class="value col-md-8">{{developer.nextVacation}}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 ">
                                                    <p class="AddInfoTitle">Project Historical Data</p>
                                                    <div class="addInfoBody scroll" >
                                                        <div class="row borderBottom" ng-repeat="project in developer.contact.Resource_Projects__r">
                                                            <div class="withoutMarge col-md-6 text-left" >
                                                                {{project.Project__r.Name}}
                                                            </div>
                                                            <div class="withoutMarge col-md-6 text-right" >
                                                                {{project.Start_Date__c | date:"MMMM yyyy"}}
                                                                -
                                                                {{project.End_Date__c | date:"MMMM yyyy"}}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <p class="AddInfoTitle">Skills and Certificates</p>
                                                    <div class="addInfoBody">
                                                        <p class="withoutMarge" ng-repeat="skill in developer.contact.Employees__r.Skill__r.Name">
                                                            {{skill}}
                                                        </p>
                                                        <p class="withoutMarge" ng-repeat="certificate in developer.contact.Employees_Certifications__r.Certificate__r.Name">
                                                            {{certificate}}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                       </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Paginator -->
                        <div id="PaginationBlock" class="row ">
                            <div class="col-md-4 my-col text-left">
                                <label for="slcRecordsOnPage" >Records on page</label>
                                <select   ng-model="paginator.developersPerPage"
                                          ng-options="records for records in paginator.POSSIBLE_DEVELOPERS_PER_PAGE"
                                          id="slcRecordsOnPage"
                                          class="form-control">
                                </select>
                            </div>
                            <div class="col-md-4 my-col text-center">
                                <div>
                                    <button class="btn btn-secondary " ng-disabled="!paginator.hasPrevious()" ng-click="paginator.pageBack()">
                                        &lt; Previous
                                    </button>
                                    <span>
                                        {{paginator.showPageInfo()}}
                                    </span>
                                    <button class="btn btn-secondary " ng-disabled="!paginator.hasNext()" ng-click="paginator.pageForward()">
                                        Next &gt;
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4 my-col text-right">
                                <label for="slcPages" >Page</label>
                                <select   ng-model="paginator.currentPage"
                                          ng-options="page + 1 for page in paginator.pages()"
                                          id="slcPages"
                                          class="form-control">
                                </select>
                                <label> of {{paginator.numberOfPages()}} </label>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Filter panel -->
                <div   class="col-md-2 right-column " >
                    <div class="container row" >
                        <div id="divRightBunner" class="titleFilter">
                            <h4>Filter Results</h4>
                        </div>
                        <div>
                            <div class="paddingBottom">
                                <p class="weight">Account</p>
                                <div ng-repeat="account in filters.accounts">
                                    <label class="checkbox-inline">
                                        <input type="checkbox" ng-model="account['Checked']"/> {{account.Name}}
                                    </label>
                                </div>
                            </div>
                            <div class="paddingBottom">
                                <p class="weight">Department</p>
                                <div ng-repeat="department in filters.departments" >
                                    <label class="checkbox-inline" >
                                        <input type="checkbox" ng-model="department['Checked']"/> {{department.Name}}
                                    </label>
                                </div>
                            </div>
                            <div class="paddingBottom">
                                <p class="weight">Immediately available</p>
                                <label class="checkbox-inline" >
                                    <input type="checkbox" id="chbAvailable" ng-model="filters.immediateAvailable"/> Yes
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>

        var ResAndAvailApp = angular.module('ResAndAvail', []);

        ResAndAvailApp.filter('startFrom', function() {
            return function(input, start) {
                return input.slice(start);
            };
        });

        ResAndAvailApp.filter('paginator', function() {
            return function(input, paginator) {
                if (paginator.developersCount != input.length) {
                    paginator.developersCount = input.length;
                    paginator.currentPage = 0;
                }
                var startPosition = paginator.currentPage * paginator.developersPerPage;
                return input.slice(startPosition, startPosition + paginator.developersPerPage);
            };
        });

        ResAndAvailApp.filter('projects', function() {
            return function(input, project, history) {
                if (!project || !project.hasOwnProperty('Id')) {
                    return input;
                }
                return input.filter(function(value) {
                    if (!history) {
                        return (value.hasOwnProperty('currentProject') && value.currentProject.Project__c == project.Id);
                    }
                    if (!value.contact.Resource_Projects__r) {
                        return false;
                    }
                    var result = false;
                    value.contact.Resource_Projects__r.forEach(function(value) {
                        result = (value.Project__c == project.Id) || result;
                    });
                    return result;
                });
            };
        });

        ResAndAvailApp.filter('clients', function() {
            return function(input, client, history) {
                if (!client || !client.hasOwnProperty('Id')) {
                    return input;
                }
                return input.filter(function(value) {
                    if (!history) {
                        return (value.hasOwnProperty('currentProject') && value.currentProject.Project__r.Customer__c == client.Id);
                    }
                    if (!value.contact.Resource_Projects__r) {
                        return false;
                    }
                    var result = false;
                    value.contact.Resource_Projects__r.forEach(function(value) {
                        result = (value.Project__r.Customer__c == client.Id) || result;
                    });
                    return result;
                });
            };
        });

        ResAndAvailApp.filter('accounts', function() {
            var someChecked = function(value) {
                return value.Checked;
            }
            var everyChecked = function(value) {
                return value.Checked;
            }
            return function(input, accounts) {
                if (!accounts.some(someChecked) || accounts.every(everyChecked)) {
                    return input;
                }
                var selectedAccounts = {};
                accounts.forEach(function(value) {
                    if (value.Checked) {
                        selectedAccounts[value.Name] = true;
                    }
                });
                return input.filter(function(value) {
                    return selectedAccounts.hasOwnProperty(value.contact.Account.Name);
                });
            };
        });

        ResAndAvailApp.filter('departments', function() {
            var someChecked = function(value) {
                return value.Checked;
            }
            var everyChecked = function(value) {
                return value.Checked;
            }
            return function(input, departments) {
                if (!departments.some(someChecked) || departments.every(everyChecked)) {
                    return input;
                }
                var selectedDepartments = {};
                departments.forEach(function(value) {
                    if (value.Checked) {
                        selectedDepartments[value.Name] = true;
                    }
                });
                return input.filter(function(value) {
                    return selectedDepartments.hasOwnProperty(value.contact.Job_Title__c);
                });
            };
        });

        ResAndAvailApp.filter('available', function() {
            return function(input, available) {
                if (!available) {
                    return input;
                }
                return input.filter(function(value) {
                    return value.availabilityHours > 0;
                });
            };
        });

        ResAndAvailApp.factory('getData', ['$q', '$rootScope', function($q, $rootScope) {
            return function(inputString) {
                var deferred = $q.defer();
                if ($rootScope.getDataStatus != 'InProgress') {
                    $rootScope.getDataStatus = 'InProgress';
                    Visualforce.remoting.Manager.invokeAction(
                        '{!$RemoteAction.ResourcesAndAvailabilityController.getData}',
                        JSON.stringify(inputString),
                        function(result, event) {
                            $rootScope.$apply(function() {
                                if (event.status) {
                                    deferred.resolve(result);
                                    $rootScope.getDataStatus = 'Finished';
                                } else {
                                    deferred.reject(event);
                                    $rootScope.getDataStatus = 'Finished';
                                }
                            })
                        },
                        { buffer: true, escape: true, timeout: 30000 }
                    );
                } else {
                    deferred = null;
                    return null;
                }
                return deferred.promise;
            }
        }]);

        ResAndAvailApp.controller('ResAndAvailCtrl', ['$scope', '$filter' ,'getData', function($scope, $filter, getData) {

            $scope.bookmarkedPeople = [];

            $scope.filters = {
                selectedProject: null,
                projectHistory: false,
                selectedClient: null,
                clientHistory: false,
                accounts: [],
                departments: [],
                immediateAvailable: false
            };

            $scope.sort = {
                columns: ['+contact.Job_Title__c', '+contact.Name']
            };

            $scope.allDataFromServer = {};
            $scope.tableData = [];

            $scope.paginator = {
                POSSIBLE_DEVELOPERS_PER_PAGE: [5, 10, 20, 50, 100],
                currentPage: 0,
                developersPerPage: 5,
                developersCount: 0,
                numberOfPages: function() {
                    return Math.ceil(this.developersCount / this.developersPerPage);
                },
                hasPrevious: function() {
                    return this.currentPage > 0;
                },
                hasNext: function() {
                    return this.currentPage < this.numberOfPages() - 1;
                },
                pageBack: function() {
                    this.currentPage = this.currentPage - 1;
                },
                pageForward: function() {
                    this.currentPage = this.currentPage + 1;
                },
                showPageInfo: function() {
                    let fromRecord = (this.developersCount > 0) ? this.currentPage * this.developersPerPage + 1 : 0;
                    let lastRecordOnPage = (this.currentPage + 1) * this.developersPerPage;
                    let toRecord = (lastRecordOnPage > this.developersCount) ? this.developersCount : lastRecordOnPage;
                    return fromRecord + ' - ' + toRecord + ' of ' + this.developersCount;
                },
                pages: function() {
                    let arr = [];
                    for (var i = 0; i < this.numberOfPages(); i++) {
                        arr.push(i);
                    }
                    return arr;
                },
            };

            $scope.readingDataForTable = function() {
                $scope.tableData = $scope.allDataFromServer.ContactsWrap;
                // $scope.paginator.developersCount = $scope.tableData.length;
                // console.dir($scope.tableData);
            }

            $scope.updateDataFromServer = function() {
                var def = getData( {keyword: ''} );
                if (def != null) {
                    $scope.queryQueue = false;
                    def.then(
                        function(result) {
                            $scope.allDataFromServer = result;
                            $scope.filters.selectedProject = $scope.allDataFromServer.Projects[0];
                            $scope.filters.selectedClient = $scope.allDataFromServer.Clients[0];
                            $scope.filters.accounts = $scope.allDataFromServer.Accounts.map(function(value) {
                                return {
                                    Name: value,
                                    Checked: false
                                }
                            });
                            $scope.filters.departments = $scope.allDataFromServer.Departments.map(function(value) {
                                return {
                                    Name: value,
                                    Checked: false
                                }
                            });
                            if ($scope.queryQueue == true) {
                                $scope.updateDataFromServer();
                            }
                            $scope.readingDataForTable();
                        },
                        function(error) {
                            $scope.allDataFromServer = error;
                        }
                    );
                } else {
                    $scope.queryQueue = true;
                }
            };
            $scope.updateDataFromServer();

        }]);

    </script>


</apex:page>