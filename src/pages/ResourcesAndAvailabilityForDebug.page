<apex:page controller="ResourcesAndAvailabilityController"
    showHeader="true"
    sidebar="false"
    title="Resources&amp;Availability"
    standardStylesheets="false">

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.1/angular.min.js"></script>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />    

    <head>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    </head>

    <style type="text/css">
                
        .same-row {
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            flex-wrap: wrap;
        }
        .same-row > [class*='col-'] {
            display: flex;
            flex-direction: column;
        }

        .addInfoBody {
            border: 1px solid lightgrey;
        }

        .form-control {
            width:auto;
            display:inline-block;
        }
        .form-group {
            margin: 0px;
        }
        .container {
            width: auto;
            height: 100%;
            margin: 5px 5px 0px 5px;
            padding: 5px;
            border: 1px solid black;
            border-radius: 5px;
        }

        .left-column .container {
            margin-right: 0px;
        }

        .paddingBottom {
            padding-bottom: 20px;
        }     
        .left-column {
            padding-right: 0px;
        }
        .right-column {
            padding-left: 0px;
        }

        .hotpink {
            background-color: #F69393;
        }

        .hotpink:hover {
            background-color: hotpink;
        }
        .yellow {
            background-color: #EFDC5D;
        }

        .yellow:hover {
            background-color: #E4C707;
        }      

        .lightblue {
            background-color: lightblue;
        }
        .lightgreen {
            background-color: #8FF78D;
        }


        .lightgreen:hover {
            background-color: #4AFA47;
        }
        .blue {
            background: #8D9BF7;
            color: white;
        }

        .weight {
            font-weight: bold;
        }

        .AddInfoTable {
            border-top: 0px solid;
            width: 100%;
        }

        .AddInfoTable td {
            vertical-align: top; 
        }

        .AddInfoTitle {
            font-weight: bold;
            text-decoration: underline;
        }

        .titleFilter {
            border-bottom: 1px solid black;
            margin-bottom: 20px;
        }
             
    </style>

    <div ng-app="ResAndAvail" ng-controller="ResAndAvailCtrl">        
        <div ng-show="!readyToShow">             
            Loading data... Please wait...
        </div>

        <div ng-show="readyToShow" class="ng-hide">

            <!-- Header's panels -->
            <div class="row">
                <!-- Header with logo -->
                <div id="divHeader" class="col-md-12">
                    <div class="container lightblue">
                        <apex:image id="VRPLogo" url="{!URLFOR($Resource.vrprce__Logos, '/VRP.png')}" height="10%" width="10%" />
                        VRP Thinking globally, delivering locally
                    </div>
                </div>

                <!-- Bookmarks panel -->
                <div id="bookmakerViewer" class="col-md-12">
                    <div class="container blue">
                        Bookmarked:
                        <span ng-show="bookmarkedPeople.length == 0">
                            None
                        </span>
                        <button id="btnReserve" class="btn btn-default" ng-show="bookmarkedPeople.length > 0">
                            Reserve / Allocate Selected
                        </button>
                    </div>
                </div>

                <!-- Searching panel -->
                <div class="col-md-12">
                    <div class="container blue">
                        <div id="divSearching" class="form-group row">
                            <div class="col-md-5 text-center">
                                <label for="slcProjects">Projects</label>
                                <select id="slcProjects" class="form-control">
                                    <option ng-repeat="project in allData.Projects">{{project.Name}}</option>
                                </select>

                                <label class="checkbox-inline" >
                                    <input type="checkbox" id="chbProjectHistory"/>
                                    Include historical data
                                </label>
                            </div>

                            <div class="col-md-5 text-center">
                                <label for="slcClients">Client</label>
                                <select id="slcClients" class="form-control">
                                    <option ng-repeat="client in allData.Clients">{{client.Account__r.Name}}</option>
                                </select>

                                <label class="checkbox-inline" >
                                    <input type="checkbox" id="chbClientHistory"/>
                                    Include historical data
                                </label>

                                <button id="btnSearch" class="btn btn-default ">
                                    Search
                                </button>
                            </div>

                            <div class="col-md-2 text-center">
                                <button id="btnMapView" class="btn btn-default ">
                                    Map View
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main table block -->
            <div class="row same-row">
                <div   class="col-md-10 left-column ">
                    <div class="container">

                        <div id="divMainTable">
                            <table class="table">
                                <thead>
                                    <th>Full Name</th>
                                    <th>Department</th>
                                    <th>Experience Level</th>
                                    <th>English Level</th>
                                    <th>US Visa</th>
                                    <th>Immediate Availability (h)</th>
                                    <th>Project Allocation</th>
                                    <th>From</th>
                                    <th>To</th>
                                    <th>Team Lead</th>
                                    <th>Account</th>
                                </thead>
                                <tbody>
                                    <tr ng-repeat-start="developer in allData.ContactsWrap | startFrom: paginator.currentPage * paginator.developersPerPage | limitTo: paginator.developersPerPage" ng-class="developer.availabilityHours == 0 ? 'hotpink' : (developer.Immediate <= 4 ? 'yellow' : 'lightgreen')" ng-click="isAddInfoVisible = !isAddInfoVisible">
                                        <td>{{developer.contact.Name}}</td>
                                        <td>{{developer.contact.Job_Title__c}}</td>
                                        <td>{{developer.contact.Experience_Level__c}}</td>
                                        <td>{{developer.contact.English_Level__c}}</td>
                                        <td>
                                            <p ng-show="developer.contact.Employee_Private_Documents__r">true</p>
                                        </td>
                                        <td>{{developer.availabilityHours}} {{developer.availabilityAddInfo}}</td>
                                        <td>{{developer.currentProject.Project__r.Name}}</td>
                                        <td>{{developer.currentProject.Start_Date__c | date:"mm/dd/yyyy"}}</td>
                                        <td>{{developer.currentProject.End_Date__c | date:"mm/dd/yyyy"}}</td>
                                        <td>{{developer.contact.Employee_User__r.Manager.Name}}</td>
                                        <td>{{developer.contact.Account.Name}}</td>
                                    </tr>
                                   
                                    <tr ng-show="isAddInfoVisible" ng-repeat-end="ng-repeat-end">
                                       <td colspan="11">
                                            <table class="AddInfoTable" id="addInfo" >
                                                <td>
                                                    <p class="AddInfoTitle">Contact Infornation</p>                                                   
                                                        <table class="addInfoBody">
                                                            <tr>
                                                                <td>Email</td>
                                                                <td>{{developer.contact.Email}}</td>
                                                            </tr>
                                                            <tr>
                                                                <td>Phone</td>
                                                                <td>{{developer.contact.Phone}}</td>
                                                            </tr>
                                                            <tr>
                                                                <td>Skype</td>
                                                                <td>{{developer.contact.Skype__c}}</td>
                                                            </tr>
                                                            <tr>
                                                                <td>Google Talk</td>
                                                                <td>{{developer.contact.Google_Talk__c}}</td>
                                                            </tr>
                                                            <tr>
                                                                <td>Hired Date</td>
                                                                <td>{{developer.contact.Hired_Date__c | date:"MM/dd/yyyy"}}</td>
                                                            </tr>
                                                            <tr>
                                                                <td>Emergensy phone</td>
                                                                <td>{{developer.contact.Emergency_Phone__c}}</td>
                                                            </tr>
                                                            <tr>
                                                                <td>Vacation Last</td>
                                                                <td>??/??/????</td>
                                                            </tr>
                                                            <tr>
                                                                <td>Vacation Next</td>
                                                                <td>??/??/????</td>
                                                            </tr>
                                                        </table>
                                                    
                                                </td>
                                                <td>
                                                    <p class="AddInfoTitle">Project Historical Data</p>
                                                </td>
                                                <td>
                                                    <p class="AddInfoTitle">Skills and Certificates</p>
                                                        <p> Salesforce developer </p>
                                                        <p> Salesforce administrator </p>
                                                        <p> Angular certificate </p>
                                                </td>
                                            </table>
                                       </td> 
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Paginator -->
                        <div id="PaginationBlock" class="row ">
                            <div class="col-md-4 my-col text-center">
                            </div>
                            <div class="col-md-4 my-col text-center">
                                <div>
                                    <button class="btn btn-secondary " ng-disabled="!paginator.hasPrevious()" ng-click="paginator.pageBack()">
                                        &lt; Previous
                                    </button>                                    
                                    <span>
                                        {{paginator.showPageInfo()}}
                                    </span>
                                    <button class="btn btn-secondary " ng-disabled="!paginator.hasNext()" ng-click="paginator.pageForward()">
                                        Next &gt;
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4 my-col text-right">
                                <label for="slcPages" >Page</label>
                                <select id="slcPages" class="form-control">
                                    <option>1</option>
                                    <option>2</option>
                                    <option>3</option>
                                    <option>4</option>
                                </select>
                                <label> of 4 </label>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Filter panel -->
                <div   class="col-md-2 right-column " >
                    <div class="container row" >
                        <div id="divRightBunner" class="titleFilter">
                            <h4>Filter Results</h4>
                        </div>
                        <div>
                            <div class="paddingBottom">
                                <p class="weight">Account</p>
                                <div ng-repeat="account in allData.Accounts">
                                    <label class="checkbox-inline"  >
                                        <input type="checkbox" /> {{account}}
                                    </label>
                                </div>
                            </div>
                            <div class="paddingBottom">
                                <p class="weight">Department</p>
                                <div ng-repeat="department in allData.Departments" >
                                    <label class="checkbox-inline" >
                                        <input type="checkbox" /> {{department}}
                                    </label>
                                </div>
                            </div>
                            <div class="paddingBottom">
                                <p class="weight">Immediately available</p>
                                <label class="checkbox-inline" >
                                    <input type="checkbox" id="chbAvailable" /> Yes
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script>

        var ResAndAvailApp = angular.module('ResAndAvail', []);

        ResAndAvailApp.filter('startFrom', function() {
            return function(input, start) {
                return input.slice(start);
            };
        });

        ResAndAvailApp.factory('getData', ['$q', '$rootScope', function($q, $rootScope) {
            return function(inputString) {
                var deferred = $q.defer();
                if ($rootScope.getDataStatus != 'InProgress') {
                    $rootScope.getDataStatus = 'InProgress';
                    Visualforce.remoting.Manager.invokeAction(
                        '{!$RemoteAction.ResourcesAndAvailabilityController.getData}',
                        JSON.stringify(inputString),
                        function(result, event) {
                            $rootScope.$apply(function() {
                                if (event.status) {
                                    deferred.resolve(result);
                                    $rootScope.getDataStatus = 'Finished';
                                } else {
                                    deferred.reject(event);
                                    $rootScope.getDataStatus = 'Finished';
                                }
                            })
                        },
                        { buffer: true, escape: true, timeout: 30000 }
                    );
                } else {
                    deferred = null;
                    return null;
                }
                return deferred.promise;
            }
        }]);

        ResAndAvailApp.controller('ResAndAvailCtrl', ['$scope', '$filter' ,'getData', function($scope, $filter, getData) {
            $scope.readyToShow = false;

            $scope.bookmarkedPeople = [];

            $scope.allData = {
                'ContactsWrap': []
            };
			
			$scope.isAddInfoVisible = false;
			
            $scope.paginator = {
                currentPage: 0,
                developersPerPage: 5,
                developersCount: 0,
                numberOfPages: function() {
                    return Math.ceil($scope.allData.ContactsWrap.length / this.developersPerPage);
                },
                hasPrevious: function() {
                    return this.currentPage > 0;
                },
                hasNext: function() {
                    return this.currentPage < this.numberOfPages() - 1;
                },
                pageBack: function() {
                    this.currentPage = this.currentPage - 1;
                },
                pageForward: function() {
                    this.currentPage = this.currentPage + 1;
                },
                showPageInfo: function() {
                    let fromRecord = this.currentPage * this.developersPerPage + 1;
                    let lastRecordOnPage = (this.currentPage + 1) * this.developersPerPage;
                    let toRecord = (lastRecordOnPage > this.developersCount) ? this.developersCount : lastRecordOnPage;
                    return fromRecord + ' - ' + toRecord + ' of ' + this.developersCount;
                }
            };

            $scope.queryUpdate = function () {
                var def = getData( {keyword: ''} );
                if (def != null) {
                    $scope.queryQueue = false;
                    def.then(
                        function(result) {
                            $scope.allData = result;
                            $scope.paginator.developersCount = $scope.allData.ContactsWrap.length;
                            $scope.readyToShow = true;
                            if ($scope.queryQueue == true) {
                                $scope.queryUpdate();
                            }
                        },
                        function(error) {
                            $scope.serverData = error;
                        }
                    );
                } else {
                    $scope.queryQueue = true;
                }
            };
            $scope.queryUpdate();

        }]);

    </script>


</apex:page>